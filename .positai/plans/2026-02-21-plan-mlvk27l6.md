# Plan: `piggyback`-based External Data Library

## Goal

Allow the `clinTrialData` package to grow its dataset library without being
constrained by CRAN's ~5MB tarball size limit. Datasets are hosted as assets
on GitHub Releases and downloaded on demand, with local caching. The CRAN
package stays lean (functions only, no bundled parquet files).

---

## Architecture Overview

```
GitHub Release (v1.0, v2.0, ...)
  └── cdisc_pilot.zip          ← parquet files, zipped per study
  └── cdisc_pilot_extended.zip
  └── new_study.zip            ← future additions, zero code changes needed

User calls:
  download_study("cdisc_pilot")   → downloads + caches → locks
  connect_clinical_data("cdisc_pilot")  → reads from cache (unchanged API)
```

The two existing exported functions (`connect_clinical_data()`,
`list_data_sources()`) keep their exact signatures. All new functionality is
additive.

---

## Files to Create / Modify

### 1. New file: `R/download.R`

Three exported functions:

- **`download_study(source, version = "latest", force = FALSE)`**  
  Downloads a study zip from the GitHub release asset, unzips into the user's
  cache dir (`tools::R_user_dir("clinTrialData", "cache")`), and locks it.  
  Skips download if already cached (unless `force = TRUE`).  
  Uses `piggyback::pb_download()` under the hood.

- **`list_available_studies()`**  
  Lists all studies available across all GitHub releases (both cached locally
  and available remotely). Returns a data frame with columns: `source`,
  `version`, `size_mb`, `cached`.

- **`cache_dir()`**  
  Simple helper that returns the path to the local cache. Useful for users
  who want to inspect or clear it manually.

### 2. Modify: `R/connections.R`

- **`connect_to_source()`**: currently only looks in `system.file("exampledata", ...)`.  
  Extend it to also check the user cache dir. Priority order:  
  1. User cache (`tools::R_user_dir("clinTrialData", "cache")`)  
  2. Package-bundled data (`system.file("exampledata", ...)`)  
  If neither exists, give a helpful error pointing to `download_study()`.

- **`list_data_sources()`**: extend to combine bundled + cached sources into
  one data frame, adding a `location` column (`"bundled"` or `"cached"`).

### 3. Modify: `DESCRIPTION`

- Add `piggyback` to `Suggests` (not `Imports` — download is opt-in).
- Add `tools` to `Imports` (already base R, but needs explicit declaration for
  `tools::R_user_dir()`).

### 4. Modify: `inst/exampledata/` (post-CRAN work)

- Remove bundled parquet files from the package source (after CRAN acceptance).
- Replace with a `README` explaining data is downloaded via `download_study()`.
- This is the step that actually shrinks the tarball. It's intentionally
  deferred so the package can be submitted to CRAN *with* bundled data first,
  then the data is migrated to releases in a follow-up version (0.2.0).

### 5. New file: `data-raw/upload_to_release.R`

A script (not shipped to users, excluded by `.Rbuildignore`) that:
- Zips each study folder from `inst/exampledata/`
- Creates a GitHub release tagged with the version
- Uploads the zips as release assets using `piggyback::pb_upload()`

This is what the maintainer runs when adding a new dataset.

---

## User Experience

### Installing and using a downloaded dataset

```r
# First time: download from GitHub release
clinTrialData::download_study("cdisc_pilot")
#> ✔ Downloading cdisc_pilot (v1.0.0) — 9.2 MB
#> ✔ Cached to ~/.cache/R/clinTrialData/cdisc_pilot

# Connect as before — API unchanged
db <- clinTrialData::connect_clinical_data("cdisc_pilot")
adsl <- db$adam$read_cnt("adsl")

# See what's available locally and remotely
clinTrialData::list_available_studies()
#>               source version size_mb cached
#> 1        cdisc_pilot   1.0.0     9.2   TRUE
#> 2 cdisc_pilot_extended 1.0.0   9.2  FALSE
#> 3       new_study_xyz   1.0.0   4.1  FALSE
```

### Adding a new dataset (maintainer workflow)

```r
# 1. Add parquet files to inst/exampledata/new_study/
# 2. Run the upload script:
source("data-raw/upload_to_release.R")
upload_study_to_release("new_study", version = "1.1.0")
# No CRAN resubmission needed — users get it via download_study()
```

---

## What This Does NOT Change

- `connect_clinical_data()` signature — unchanged
- `list_data_sources()` signature — unchanged (just gains a `location` column)
- The lock protection mechanism — all cached data gets locked after download
- CRAN submission — the package is submitted first as-is (v0.1.0 with bundled
  data); the migration to fully remote data happens in v0.2.0

---

## Step-by-Step Implementation Order

1. Add `piggyback` to `Suggests` in DESCRIPTION
2. Create `R/download.R` with `download_study()`, `list_available_studies()`, `cache_dir()`
3. Update `connect_to_source()` in `connections.R` to check cache first
4. Update `list_data_sources()` to include cached sources + `location` column
5. Create `data-raw/upload_to_release.R` for maintainer use
6. Add roxygen docs + examples for all new exported functions
7. Re-run `roxygen2::roxygenise()` to update NAMESPACE and man pages
8. Rebuild vignettes and run final `R CMD check --as-cran`
